<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>é«˜é“å¹¿æ’­æ¨¡æ‹Ÿç³»ç»Ÿ3.0</title>
  <style>
    :root {
      --primary: #0F3460;
      --secondary: #1A3A63;
      --accent: #E94560;
      --light: #F5F7FA;
      --dark: #16213E;
      --gray: #86909C;
      --shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
      --border-radius: 12px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --watermark-spacing: 300px; /* æ°´å°é—´è· */
      --watermark-size: 200px; /* æ°´å°å¤§å° */
    }
    
    /* åŸºç¡€æ ·å¼é‡ç½® */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body { 
      font-family: 'Inter', 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; 
      padding: 20px; 
      max-width: 1400px; 
      margin: 0 auto;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4eaf5 100%);
      color: var(--dark);
      line-height: 1.6;
      min-height: 100vh;
      position: relative;
    }
    
    /* æ»¡å±æ°´å°æ ·å¼ */
    .watermark {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 9999;
      overflow: hidden;
      opacity: 0.05;
      background-image: 
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200' viewBox='0 0 200 200'%3E%3Ctext x='50%25' y='50%25' font-family='Arial' font-size='16' fill='%23000' text-anchor='middle' dominant-baseline='middle' transform='rotate(-45, 100, 100)'%3Eé«˜é“å¹¿æ’­å¤§ä½¬qq3834797121%3C/text%3E%3C/svg%3E");
      background-size: var(--watermark-size) var(--watermark-size);
      background-repeat: repeat;
      background-position: 0 0;
    }
    
    /* LEDæ—¶é—´æ ·å¼ */
    .led-time {
      font-family: 'Courier New', Courier, monospace;
      font-size: 24px;
      color: #39FF14;
      text-shadow: 0 0 5px #39FF14, 0 0 10px #39FF14, 0 0 15px #39FF14;
      background-color: #0a1a05;
      padding: 5px 15px;
      border-radius: 5px;
      letter-spacing: 3px;
      display: inline-block;
      min-width: 90px;
      text-align: center;
      box-shadow: 0 0 10px rgba(57, 255, 20, 0.3);
      animation: ledPulse 2s infinite alternate;
    }
    
    @keyframes ledPulse {
      from { opacity: 0.9; }
      to { opacity: 1; text-shadow: 0 0 5px #39FF14, 0 0 15px #39FF14, 0 0 20px #39FF14; }
    }
    
    /* æ¬¢è¿é¡µé¢æ ·å¼ */
    .welcome-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, var(--dark), var(--secondary));
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      color: white;
      text-align: center;
      padding: 20px;
    }
    
    .welcome-title {
      font-size: 4rem;
      font-weight: 800;
      margin-bottom: 20px;
      background: linear-gradient(90deg, #ffffff, #E94560);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      text-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      animation: fadeIn 1.2s ease-out;
    }
    
    .welcome-subtitle {
      font-size: 1.5rem;
      color: #E94560;
      margin-bottom: 50px;
      font-weight: 500;
      letter-spacing: 1px;
      animation: fadeIn 1.5s ease-out;
    }
    
    .enter-button {
      padding: 18px 40px;
      font-size: 1.2rem;
      background: linear-gradient(90deg, #E94560, #ff5e7b);
      color: white;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      transition: var(--transition);
      box-shadow: 0 10px 25px rgba(233, 69, 96, 0.3);
      font-weight: 600;
      animation: fadeInUp 1.8s ease-out;
    }
    
    .enter-button:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 30px rgba(233, 69, 96, 0.4);
    }
    
    /* æ ‡é¢˜æ ·å¼ */
    h2 {
      color: var(--primary);
      text-align: center;
      margin: 30px 0 40px;
      font-weight: 700;
      font-size: 2rem;
      letter-spacing: 0.5px;
      position: relative;
      display: inline-block;
      left: 50%;
      transform: translateX(-50%);
    }
    
    h2::after {
      content: "";
      position: absolute;
      bottom: -10px;
      left: 10%;
      width: 80%;
      height: 4px;
      background: linear-gradient(90deg, transparent, var(--accent), transparent);
      border-radius: 2px;
    }
    
    /* è¡¨å•å…ƒç´ æ ·å¼ */
    textarea, input[type='time'], input[type='text'], input[type='number'], input[type='range'] { 
      width: 100%; 
      font-size: 16px;
      padding: 12px 15px;
      border: 1px solid #d1d9e6;
      border-radius: var(--border-radius);
      box-sizing: border-box;
      transition: var(--transition);
      background-color: white;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.03);
    }
    
    textarea:focus, input:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 3px rgba(15, 52, 96, 0.1);
      transform: translateY(-2px);
    }
    
    /* æŒ‰é’®æ ·å¼ */
    button {
      font-size: 15px;
      margin: 5px;
      padding: 10px 20px;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: var(--transition);
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    button:not(.clear-button):not(.danger):not(.save-audio-button):not(.enter-button) {
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      color: white;
      box-shadow: 0 4px 10px rgba(15, 52, 96, 0.2);
    }
    
    button:not(.clear-button):not(.danger):not(.save-audio-button):not(.enter-button):hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 15px rgba(15, 52, 96, 0.3);
    }
    
    /* å¡ç‰‡ç»„ä»¶æ ·å¼ */
    .group { 
      border: 1px solid rgba(255, 255, 255, 0.5);
      padding: 25px; 
      margin-bottom: 30px;
      border-radius: var(--border-radius);
      background: white;
      box-shadow: var(--shadow);
      transition: var(--transition);
      border-top: 4px solid var(--accent);
    }
    
    .group:hover {
      transform: translateY(-8px);
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
    }
    
    .group h3 { 
      margin: 0 0 20px; 
      color: var(--primary);
      font-weight: 600;
      font-size: 1.3rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .group h3::before {
      content: "";
      display: inline-block;
      width: 4px;
      height: 24px;
      background-color: var(--accent);
      border-radius: 2px;
    }
    
    .playlist { 
      border: 1px solid #e2e8f0; 
      padding: 20px; 
      margin-top: 20px;
      border-radius: var(--border-radius);
      background-color: #f8fafc;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }
    
    .playlist::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background-color: var(--primary);
    }
    
    .playlist:hover {
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
      transform: translateX(5px);
    }
    
    /* æ—¶é—´æ¡æ ·å¼ */
    .time-bar { 
      background: linear-gradient(135deg, var(--secondary), var(--primary));
      padding: 20px 30px; 
      margin: 0 0 30px; 
      font-size: 16px;
      border-radius: var(--border-radius);
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: var(--shadow);
    }
    
    .countdown { 
      color: #ffccd5; 
      font-weight: bold; 
      background-color: rgba(233, 69, 96, 0.2);
      padding: 3px 10px;
      border-radius: 15px;
      font-size: 14px;
    }
    
    /* æŒ‰é’®å˜ä½“æ ·å¼ */
    .clear-button {
      background-color: #f1f5f9;
      color: var(--dark);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }
    
    .clear-button:hover {
      background-color: #e2e8f0;
      transform: translateY(-2px);
    }
    
    .danger {
      background: linear-gradient(90deg, #e63946, #ff5757);
      color: white;
      box-shadow: 0 4px 10px rgba(230, 57, 70, 0.2);
    }
    
    .danger:hover {
      background: linear-gradient(90deg, #d62828, #e63946);
      transform: translateY(-3px);
      box-shadow: 0 8px 15px rgba(230, 57, 70, 0.3);
    }
    
    .save-audio-button {
      background: linear-gradient(90deg, #10b981, #34d399);
      color: white;
      box-shadow: 0 4px 10px rgba(16, 185, 129, 0.2);
    }
    
    .save-audio-button:hover {
      background: linear-gradient(90deg, #059669, #10b981);
      transform: translateY(-3px);
      box-shadow: 0 8px 15px rgba(16, 185, 129, 0.3);
    }
    
    /* æ§åˆ¶é¢æ¿æ ·å¼ */
    .control-section {
      background: white;
      padding: 30px;
      border-radius: var(--border-radius);
      margin-bottom: 30px;
      box-shadow: var(--shadow);
    }
    
    .control-group {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 20px;
    }
    
    .control-item {
      flex: 1;
      min-width: 220px;
    }
    
    label {
      display: block;
      margin-bottom: 10px;
      font-weight: 500;
      color: #475569;
      font-size: 14px;
    }
    
    .groupName {
      width: auto;
      display: inline-block;
      margin-left: 10px;
      width: 280px;
    }
    
    .playlistText {
      min-height: 120px;
      resize: vertical;
      font-family: inherit;
    }
    
    .time-bar input[type="checkbox"] {
      margin-right: 8px;
      width: 16px;
      height: 16px;
      accent-color: var(--accent);
    }
    
    .section-title {
      font-size: 1.2rem;
      margin-bottom: 20px;
      color: var(--secondary);
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .section-title::before {
      content: "";
      display: inline-block;
      width: 24px;
      height: 24px;
      background-color: var(--primary);
      border-radius: 50%;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }
    
    /* ä¿å­˜æŒ‰é’®æ ·å¼ */
    .save-button {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      color: white;
      z-index: 100;
      padding: 15px 30px;
      border-radius: 50px;
      box-shadow: 0 10px 25px rgba(15, 52, 96, 0.3);
      font-weight: 600;
      transition: var(--transition);
    }
    
    .save-button:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 30px rgba(15, 52, 96, 0.4);
    }
    
    .recording-status {
      color: #10b981;
      font-weight: 500;
      margin-left: 10px;
      display: none;
      font-size: 14px;
      background-color: rgba(16, 185, 129, 0.1);
      padding: 2px 8px;
      border-radius: 12px;
    }
    
    /* åŠ¨ç”»æ•ˆæœ */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes fadeInDown {
      from { opacity: 0; transform: translateY(-30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: var(--gray);
    }
  </style>
</head>
<body>
  <!-- æ°´å°å…ƒç´  -->
  <div class="watermark"></div>
  
  <!-- æ¬¢è¿é¡µé¢ -->
  <div class="welcome-screen" id="welcomeScreen">
    <h1 class="welcome-title">é«˜é“å¹¿æ’­æ¨¡æ‹Ÿç³»ç»Ÿ3.0</h1>
    <p class="welcome-subtitle">made up:é«˜é“å¹¿æ’­å¤§ä½¬</p>
    <button class="enter-button" onclick="enterMainPage()">è¿›å…¥ç³»ç»Ÿ</button>
  </div>

  <h2>ğŸš„ é«˜é“å¹¿æ’­æ¨¡æ‹Ÿç³»ç»Ÿ3.0</h2>
  <div class="time-bar">
    å½“å‰åŒ—äº¬æ—¶é—´ï¼š<span id="currentTime" class="led-time">--:--</span> |
    â¯ï¸ æ€»å¼€å…³ï¼š<label><input type="checkbox" id="masterSwitch" checked> å¯ç”¨</label>
    <button class="clear-button" onclick="clearLocal()">ğŸ§¹ æ¸…é™¤è®°å¿†</button>
  </div>

  <div class="control-section">
    <div class="section-title">ğŸ“Š ç³»ç»Ÿæ§åˆ¶</div>
    <label>ğŸ“‚ ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶å¤¹ï¼š
      <input type="file" id="audioFiles" webkitdirectory multiple accept="audio/*">
    </label>
    
    <div class="control-group">
      <div class="control-item">
        <label>â±ï¸ æå‰è§¦å‘(ms):
          <input type="number" id="triggerAdvance" value="200" min="0" max="2000" step="50">
        </label>
      </div>
      <div class="control-item">
        <label>ğŸ”ˆ TTSè¯­é€Ÿ:
          <input type="range" id="rate" min="0.5" max="2" value="1" step="0.1">
          <span id="rateVal">1</span>
        </label>
      </div>
      <div class="control-item">
        <label>ğŸµ éŸ³è°ƒ:
          <input type="range" id="pitch" min="0.5" max="2" value="1" step="0.1">
          <span id="pitchVal">1</span>
        </label>
      </div>
      <div class="control-item">
        <label>ğŸ§ éŸ³é¢‘å€é€Ÿ:
          <input type="range" id="audioRate" min="0.5" max="2" value="1" step="0.1">
          <span id="audioRateVal">1</span>
        </label>
      </div>
    </div>
  </div>

  <button onclick="addGroup()">â• æ·»åŠ æ’­æ”¾ç»„åˆ</button>
  <div id="groups"></div>

  <button class="save-button" onclick="saveConfiguration()">ğŸ’¾ ä¿å­˜é…ç½®</button>

  <script>
    // è¿›å…¥ä¸»é¡µé¢
    function enterMainPage() {
      const welcomeScreen = document.getElementById('welcomeScreen');
      welcomeScreen.style.opacity = '0';
      welcomeScreen.style.transform = 'scale(0.9)';
      setTimeout(() => {
        welcomeScreen.style.display = 'none';
      }, 800);
    }

    const audioMap = {};
    let currentAudio = null;
    let currentUtterance = null;
    let pausedPlayback = false;
    let mediaRecorder = null;
    let audioChunks = [];
    let audioContext = null;
    let destinationNode = null;
    let mediaStreamDestination = null;
    let isRecording = false;

    // åˆå§‹åŒ–AudioContext
    function initAudioContext() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        mediaStreamDestination = audioContext.createMediaStreamDestination();
      }
    }

    // éŸ³é¢‘æ–‡ä»¶å¤„ç†
    document.getElementById('audioFiles').addEventListener('change', function(event) {
      for (const file of event.target.files) {
        const name = file.name.replace(/\.[^/.]+$/, "");
        audioMap[name] = URL.createObjectURL(file);
      }
      alert("âœ… å·²åŠ è½½éŸ³é¢‘æ–‡ä»¶ï¼š" + Object.keys(audioMap).join(", "));
    });

    // æ—¶é—´æ˜¾ç¤ºæ›´æ–°
    function updateTimeDisplay() {
      const now = new Date();
      const beijingOffset = now.getTimezoneOffset() === -480 ? 0 : (480 + now.getTimezoneOffset());
      now.setMinutes(now.getMinutes() + beijingOffset);
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      document.getElementById('currentTime').innerText = `${hours}:${minutes}`;
    }
    setInterval(updateTimeDisplay, 1000);
    updateTimeDisplay();

    // æ§åˆ¶æ¡æ•°å€¼æ˜¾ç¤º
    document.getElementById('rate').oninput = e => document.getElementById('rateVal').innerText = e.target.value;
    document.getElementById('pitch').oninput = e => document.getElementById('pitchVal').innerText = e.target.value;
    document.getElementById('audioRate').oninput = e => document.getElementById('audioRateVal').innerText = e.target.value;

    // æ·»åŠ ç»„åˆ
    function addGroup(data = {}) {
      const div = document.createElement('div');
      div.className = 'group';
      div.innerHTML = `
        <h3>ğŸ“ ç»„åˆåç§°ï¼š<input type="text" value="${data.name || 'æ–°ç»„åˆ'}" class="groupName"></h3>
        <button onclick="addPlaylist(this)">â• æ·»åŠ æ’­æ”¾åˆ—è¡¨</button>
        <div class="group-playlists"></div>
      `;
      document.getElementById('groups').appendChild(div);
    
      // æ·»åŠ åŠ¨ç”»æ•ˆæœ
      setTimeout(() => {
        div.style.opacity = '1';
        div.style.transform = 'translateY(0)';
      }, 10);
    }

    // æ·»åŠ æ’­æ”¾åˆ—è¡¨
    function addPlaylist(button) {
      const container = button.closest('.group');
      const listDiv = document.createElement('div');
      listDiv.className = 'playlist';
      listDiv.style.opacity = '0';
      listDiv.style.transform = 'translateY(20px)';
      listDiv.innerHTML = `
        <label>å®šæ—¶å¯åŠ¨æ—¶é—´ï¼š
          <input type="time" class="startTime">
        </label><br>
        <textarea class="playlistText" rows="4" placeholder="è¾“å…¥æ’­æ”¾å†…å®¹..."></textarea><br>
        <div>â³ å€’è®¡æ—¶ï¼š<span class="countdown">æœªè®¾ç½®</span><span class="recording-status">æ­£åœ¨å½•åˆ¶...</span></div>
        <button onclick="startPlaylist(this)">â–¶ï¸ æ’­æ”¾</button>
        <button onclick="pausePlayback()">â¸ï¸ æš‚åœ</button>
        <button onclick="resumePlayback()">âµï¸ ç»§ç»­</button>
        <button onclick="cancelPlayback()" class="danger">â¹ï¸ åœæ­¢</button>
        <button class="save-audio-button" onclick="saveAudio(this)">ğŸ’¾ ä¿å­˜éŸ³é¢‘</button>
      `;
      container.querySelector('.group-playlists').appendChild(listDiv);
    
      // æ·»åŠ åŠ¨ç”»æ•ˆæœ
      setTimeout(() => {
        listDiv.style.opacity = '1';
        listDiv.style.transform = 'translateY(0)';
      }, 10);
    }

    // å¼€å§‹å½•åˆ¶éŸ³é¢‘
    function startRecording() {
      if (isRecording) return;
      
      initAudioContext();
      
      // åˆ›å»ºMediaRecorderå®ä¾‹
      const stream = mediaStreamDestination.stream;
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];
      
      mediaRecorder.ondataavailable = function(e) {
        if (e.data.size > 0) {
          audioChunks.push(e.data);
        }
      };
      
      mediaRecorder.onstop = function() {
        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
        const audioUrl = URL.createObjectURL(audioBlob);
        
        // å­˜å‚¨å½•åˆ¶çš„éŸ³é¢‘ä¾›åç»­ä¸‹è½½
        window.recordedAudio = audioBlob;
        
        isRecording = false;
        document.querySelectorAll('.recording-status').forEach(el => {
          el.style.display = 'none';
        });
      };
      
      mediaRecorder.start();
      isRecording = true;
      
      // æ˜¾ç¤ºå½•åˆ¶çŠ¶æ€
      document.querySelectorAll('.recording-status').forEach(el => {
        el.style.display = 'inline';
      });
    }

    // åœæ­¢å½•åˆ¶éŸ³é¢‘
    function stopRecording() {
      if (mediaRecorder && isRecording) {
        mediaRecorder.stop();
      }
    }

    // ä¿å­˜éŸ³é¢‘åˆ°æœ¬åœ°
    function saveAudio(button) {
      if (!window.recordedAudio) {
        alert("âš ï¸ æ²¡æœ‰å¯ä¿å­˜çš„éŸ³é¢‘ï¼Œè¯·å…ˆæ’­æ”¾å†…å®¹");
        return;
      }
      
      const playlistDiv = button.closest('.playlist');
      const text = playlistDiv.querySelector('.playlistText').value.trim();
      const fileName = text.length > 10 ? text.substring(0, 10) + "..." : text || "é«˜é“å¹¿æ’­éŸ³é¢‘";
      
      const url = URL.createObjectURL(window.recordedAudio);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${fileName}.wav`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      alert(`âœ… éŸ³é¢‘å·²ä¿å­˜ä¸º: ${fileName}.wav`); 
    }

    // æ’­æ”¾åˆ—è¡¨å¤„ç†
    function startPlaylist(button) {
      const container = button.closest('.playlist');
      const text = container.querySelector('.playlistText').value.trim();
      if (!text) return;
      
      // å¼€å§‹å½•åˆ¶
      startRecording();
      
      const keywords = Object.keys(audioMap);
      const segments = splitTextByKeywords(text, keywords);
      playSegmentsSequentially(segments, container);
    }

    // æ–‡æœ¬åˆ†å‰²å¤„ç†
    function splitTextByKeywords(text, keywords) {
      const pattern = new RegExp("(" + keywords.map(k => k.replace(/[-/\^$*+?.()|[\]{}]/g, '\\$&')).join("|") + ")", "g");
      return text.split(pattern).filter(s => s.trim() !== "");
    }

    // é¡ºåºæ’­æ”¾ç‰‡æ®µ
    async function playSegmentsSequentially(segments, container) {
      pausedPlayback = false;
      for (let i = 0; i < segments.length; i++) {
        if (pausedPlayback) break;
        const segment = segments[i];
        if (audioMap[segment]) {
          await playAudioSegmentFlexible(audioMap[segment]);
        } else {
          await speakSegment(segment);
        }
      }
      
      // æ‰€æœ‰ç‰‡æ®µæ’­æ”¾å®Œæ¯•ååœæ­¢å½•åˆ¶
      stopRecording();
      
      // æ›´æ–°å€’è®¡æ—¶æ˜¾ç¤º
      container.querySelector('.countdown').textContent = "æ’­æ”¾å®Œæˆ";
    }

    // æ’­æ”¾éŸ³é¢‘ç‰‡æ®µ
    function playAudioSegmentFlexible(audioUrl) {
      return new Promise(resolve => {
        if (!audioContext) initAudioContext();
        
        const rate = parseFloat(document.getElementById("audioRate").value);
        const advanceMs = parseInt(document.getElementById("triggerAdvance").value);
        
        fetch(audioUrl)
          .then(response => response.arrayBuffer())
          .then(arrayBuffer => audioContext.decodeAudioData(arrayBuffer))
          .then(audioBuffer => {
            const source = audioContext.createBufferSource();
            source.buffer = audioBuffer;
            source.playbackRate.value = rate;
            
            // è¿æ¥åˆ°å½•åˆ¶ç›®æ ‡å’Œæ‰¬å£°å™¨
            source.connect(mediaStreamDestination);
            source.connect(audioContext.destination);
            
            source.start(0);
            
            const duration = audioBuffer.duration / rate;
            const triggerTime = Math.max(0, duration - advanceMs / 1000);
            
            setTimeout(() => {
              source.disconnect();
              resolve();
            }, triggerTime * 1000);
          })
          .catch(error => {
            console.error("Error playing audio segment:", error);
            resolve();
          });
      });
    }

    // è¯­éŸ³åˆæˆ
    function speakSegment(text) {
      return new Promise(resolve => {
        if (window.speechSynthesis) {
          const rate = parseFloat(document.getElementById("rate").value);
          const pitch = parseFloat(document.getElementById("pitch").value);
          
          // åˆ›å»ºè¯­éŸ³åˆæˆ utterance
          currentUtterance = new SpeechSynthesisUtterance(text);
          currentUtterance.rate = rate;
          currentUtterance.pitch = pitch;
          
          // ä½¿ç”¨Web Speech APIçš„éŸ³é¢‘è¾“å‡º
          currentUtterance.onend = resolve;
          currentUtterance.onerror = resolve;
          
          // ä¼°ç®—è¯­éŸ³æ—¶é•¿å¹¶åœ¨ç»“æŸåç»§ç»­
          const estimatedDuration = text.length * 0.1 * (1/rate); 
          setTimeout(resolve, estimatedDuration * 1000);
          
          window.speechSynthesis.speak(currentUtterance);
        } else {
          // å¦‚æœæµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åˆæˆï¼Œç›´æ¥è§£æ
          resolve();
        }
      });
    }

    // æš‚åœæ’­æ”¾
    function pausePlayback() {
      if (currentAudio) {
        currentAudio.pause();
      }
      if (window.speechSynthesis && currentUtterance) {
        window.speechSynthesis.pause();
      }
      pausedPlayback = true;
    }

    // ç»§ç»­æ’­æ”¾ 
    function resumePlayback() {
      if (currentAudio) {
        currentAudio.play();
      }
      if (window.speechSynthesis && currentUtterance) {
        window.speechSynthesis.resume();
      }
      pausedPlayback = false;
    }

    // å–æ¶ˆæ’­æ”¾
    function cancelPlayback() {
      if (currentAudio) {
        currentAudio.pause();
        currentAudio = null;
      }
      if (window.speechSynthesis && currentUtterance) {
        window.speechSynthesis.cancel();
        currentUtterance = null;
      }
      pausedPlayback = false;
      stopRecording();
    }

    // ä¿å­˜é…ç½®
    function saveConfiguration() {
      // å®ç°ä¿å­˜é…ç½®çš„é€»è¾‘
      alert("âœ… é…ç½®å·²ä¿å­˜");
    }

    // æ¸…é™¤æœ¬åœ°å­˜å‚¨
    function clearLocal() {
      localStorage.clear();
      location.reload();
    }

    // åˆå§‹åŒ–é¡µé¢
    addGroup();
    
    // æ·»åŠ é¡µé¢è½½å…¥åŠ¨ç”»
    document.addEventListener('DOMContentLoaded', function() {
      document.body.classList.add('loaded');
    });
  </script>
</body>
</html>